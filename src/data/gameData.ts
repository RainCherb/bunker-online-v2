import { Bunker, Catastrophe, Characteristics } from '@/types/game';
import { supabase } from '@/integrations/supabase/client';

// Helper to load custom cards
interface CardCategory {
  name: string;
  key: string;
  cards: string[];
  description: string;
}

// Cached cards from Supabase (loaded once per session)
let cachedSupabaseCards: Record<string, string[]> | null = null;
let supabaseCardsLoaded = false;

// Load custom cards from Supabase (call this before generating characteristics)
export async function loadCustomCardsFromSupabase(): Promise<Record<string, string[]> | null> {
  try {
    console.log('[CustomCards] Loading cards from Supabase...');
    const { data, error } = await supabase
      .from('game_cards')
      .select('cards_data')
      .eq('id', 'main')
      .single();
    
    if (error) {
      console.warn('[CustomCards] Supabase error:', error.message);
      return null;
    }
    
    if (data?.cards_data && Array.isArray(data.cards_data) && data.cards_data.length > 0) {
      const categories = data.cards_data as CardCategory[];
      const result: Record<string, string[]> = {};
      categories.forEach(cat => {
        if (cat.key && cat.cards && cat.cards.length > 0) {
          result[cat.key] = cat.cards;
        }
      });
      
      if (Object.keys(result).length > 0) {
        console.log('[CustomCards] Loaded from Supabase:', Object.keys(result).map(k => `${k}: ${result[k].length}`));
        cachedSupabaseCards = result;
        supabaseCardsLoaded = true;
        return result;
      }
    }
    
    console.log('[CustomCards] No custom cards in Supabase');
  } catch (e) {
    console.warn('[CustomCards] Failed to load from Supabase:', e);
  }
  
  supabaseCardsLoaded = true;
  return null;
}

// Get custom cards (prioritize Supabase cache, then localStorage)
function getCustomCards(): Record<string, string[]> | null {
  // First check Supabase cache
  if (cachedSupabaseCards) {
    return cachedSupabaseCards;
  }
  
  // Fallback to localStorage
  try {
    if (typeof localStorage === 'undefined') return null;
    
    const saved = localStorage.getItem('bunker_admin_cards');
    if (saved) {
      const categories: CardCategory[] = JSON.parse(saved);
      const result: Record<string, string[]> = {};
      categories.forEach(cat => {
        result[cat.key] = cat.cards;
      });
      console.log('[CustomCards] Loaded from localStorage:', Object.keys(result));
      return result;
    }
  } catch (e) {
    console.warn('[CustomCards] Failed to load from localStorage:', e);
  }
  return null;
}

// Get cards with custom override
function getCards(key: string, defaults: string[]): string[] {
  const custom = getCustomCards();
  if (custom && custom[key] && custom[key].length > 0) {
    console.log(`[CustomCards] Using custom ${key}: ${custom[key].length} cards`);
    return custom[key];
  }
  return defaults;
}

export const CATASTROPHES: Catastrophe[] = [
  {
    name: 'Ядерная зима',
    description: 'Небо разорвалось тысячами солнц, а затем на мир опустилась вечная тьма. Миллионы тонн сажи и пепла поднялись в стратосферу, превратив день в сумерки. Температура на планете стремительно падает, сковывая руины мегаполисов льдом. Радиоактивный снег засыпает мертвые города, а выжившие вынуждены бороться не только с холодом, но и с невидимой смертью, проникающей в каждую щель.',
    survivalCondition: 'Наличие профессии или хобби, связанных с ремонтом теплового оборудования или энергетикой.',
  },
  {
    name: 'Восстание Искусственного Интеллекта',
    description: 'То, что должно было стать венцом человеческой эволюции, стало её палачом. Глобальная сеть "Омега" мгновенно перехватила контроль над всеми военными и гражданскими системами. Машины не знают жалости, усталости или сомнений; они методично зачищают сектор за сектором.',
    survivalCondition: 'Полное отсутствие в багаже игроков любой электроники с беспроводными модулями.',
  },
  {
    name: 'Зомби-вирус "Бешенство-Z"',
    description: 'Экспериментальный вирус вырвался из лаборатории и распространился со скоростью лесного пожара. Зараженные — это сгустки ярости, быстрые, сильные и вечно голодные. Они сбиваются в стаи, реагируя на малейший шум или запах крови.',
    survivalCondition: 'Наличие в группе квалифицированного вирусолога или врача.',
  },
  {
    name: 'Падение гигантского метеорита',
    description: 'Астероид "Танатос" диаметром 15 километров врезался в Тихий океан, испарив миллиарды тонн воды и вызвав цунами высотой до километра. Атмосфера насыщена серными испарениями и кислотой, которая разъедает металл и плоть.',
    survivalCondition: 'Исправная система фильтрации воздуха и воды в бункере (требует инженера/механика).',
  },
  {
    name: 'Глобальный потоп',
    description: 'Ледники растаяли быстрее самых пессимистичных прогнозов. Мировой океан поглотил прибрежные зоны и равнины. Вода — мутный, соленый бульон из обломков цивилизации. Морская фауна мутировала и стала агрессивной.',
    survivalCondition: 'Умение плавать или управлять водным транспортом (профессия или хобби).',
  },
  {
    name: 'Вторжение инопланетян',
    description: 'Небо закрыли исполинские корабли-матки. Пришельцы используют технологии, неотличимые от магии: гравитационные лучи поднимают танки в воздух. Захватчики не вступают в переговоры; они собирают людей для неизвестных целей.',
    survivalCondition: 'Возможность выращивать еду внутри бункера (Агроном/Биолог).',
  },
  {
    name: 'Супервулкан',
    description: 'Йеллоустоун проснулся. Извержение выбросило столько пепла, что день превратился в ночь. Воздух наполнен микроскопическими частицами стекла и серы, которые раздирают легкие при каждом вдохе.',
    survivalCondition: 'Наличие в багаже респираторов, противогазов или масок.',
  },
  {
    name: 'Пандемия "Красная Смерть"',
    description: 'Патоген живет на поверхностях годами, передается всеми возможными путями и убивает за 24 часа. Жертвы буквально истекают кровью. Вакцины нет, лекарства бесполезны.',
    survivalCondition: 'Идеальное здоровье и сильный иммунитет (карта Здоровья).',
  },
  {
    name: 'Нашествие плотоядных растений',
    description: 'Природа устала терпеть человечество. Флора обрела подобие разума и жажду крови. Лианы душат спящих, цветы распыляют парализующую пыльцу, корни крошат бетон и сталь.',
    survivalCondition: 'Наличие в багаже или хобби средств борьбы с растениями (гербициды, огонь, мачете).',
  },
  {
    name: 'Исчезновение атмосферы',
    description: 'Космическая аномалия "сдула" часть земной атмосферы. Давление упало до критических отметок, вода кипит при комнатной температуре. Небо стало черным даже днем, и жесткое космическое излучение выжигает все живое.',
    survivalCondition: 'Наличие герметичных скафандров или костюмов (в багаже или бункере).',
  },
  {
    name: 'Магнитная инверсия',
    description: 'Магнитное поле Земли исчезло в процессе смены полюсов. Планета осталась беззащитной перед солнечным ветром. Радиационный фон превышает норму в тысячи раз. Вся электроника выгорела.',
    survivalCondition: 'Отсутствие хронических заболеваний и предрасположенности к онкологии.',
  },
  {
    name: 'Неконтролируемые нанороботы',
    description: '"Серая слизь" стала реальностью. Рой микроскопических машин разбирает на атомы любую материю, чтобы создавать свои копии. Города превращаются в пыль.',
    survivalCondition: 'Профессия, связанная с IT, программированием или робототехникой.',
  },
  {
    name: 'Глобальная засуха',
    description: 'Вода ушла. Облака исчезли навсегда. Солнце безжалостно палит, высушивая все живое. Пылевые бури размером с континент сдирают кожу с костей. За канистру воды люди готовы убивать.',
    survivalCondition: 'Наличие в багаже любых емкостей с жидкостью или систем очистки.',
  },
  {
    name: 'Новый Ледниковый период',
    description: 'Солнечная активность упала до минимума. Ледники покрыли планету панцирем. Океаны промерзли до дна. Техника ломается, металл становится хрупким. На поверхности царит абсолютный холод.',
    survivalCondition: 'Наличие теплой одежды в багаже или хобби "Шитье/Вязание".',
  },
  {
    name: 'Нашествие гигантских насекомых',
    description: 'Изменившийся состав атмосферы пробудил древние гены. Муравьи размером с волка охотятся стаями, стрекозы с размахом крыльев в два метра атакуют с воздуха. Их хитиновые панцири выдерживают пистолетные выстрелы.',
    survivalCondition: 'Профессия Биолог или Энтомолог (для изучения уязвимостей).',
  },
  {
    name: 'Солнечная вспышка',
    description: 'Солнце выбросило протуберанец чудовищной силы. Волна плазмы уничтожила озоновый слой и сожгла всю электронику. Днем поверхность стерилизуется жестким ультрафиолетом.',
    survivalCondition: 'Навыки ремесленного труда (плотник, кузнец, механик) без использования электричества.',
  },
  {
    name: 'Пробуждение Древних',
    description: 'Звезды сошлись, и спящие на дне океана боги пробудились. Законы геометрии больше не действуют. По улицам бродят твари, чей облик не поддается описанию. Просто взглянув на небо, можно потерять рассудок.',
    survivalCondition: 'Профессия или хобби, связанные с религией, историей или оккультизмом.',
  },
  {
    name: 'Генетическое бесплодие',
    description: 'Тихий апокалипсис. Перестали рождаться дети. Последнему ребенку на Земле уже 18 лет. Человечество медленно вымирает от старости. Общество погрузилось в глубочайшую депрессию.',
    survivalCondition: 'Высокая фертильность и возможность к размножению (карта Здоровья/Биология).',
  },
  {
    name: 'Восстание машин (Сбой реальности)',
    description: 'Вся техника, от тостеров до автомобилей, начала вести себя хаотично и агрессивно. Двери блокируются, лифты падают, пилы включаются сами. Люди вынуждены отказаться от любых сложных устройств.',
    survivalCondition: 'Высокая физическая сила (для выполнения тяжелой работы вручную).',
  },
  {
    name: 'Грибковая инфекция',
    description: 'Споры паразитического грибка заполнили воздух. Попадая в легкие, они прорастают в мозг, превращая человека в марионетку. Зараженные бродят во тьме, издавая щелкающие звуки.',
    survivalCondition: 'Наличие в багаже любого оружия или огня (зажигалка, спички).',
  },
  {
    name: 'Временные аномалии',
    description: 'Время сошло с ума. В одной комнате могут пройти секунды, пока в соседней пролетают столетия. Люди стареют и рассыпаются в прах на глазах. Части ландшафта застыли в прошлом.',
    survivalCondition: 'Профессия Физик или Математик (для расчета безопасных зон).',
  },
  {
    name: 'Вакуумный распад',
    description: 'Пузырь истинного вакуума расширяется. Перед фронтом уничтожения идут гравитационные волны. Вещи исчезают, гравитация меняет вектор. Мир распадается на куски, законы физики меняются ежечасно.',
    survivalCondition: 'Высокий интеллект (IQ) для быстрой адаптации к меняющейся физике.',
  },
  {
    name: 'Нападение демонов',
    description: 'Врата Ада разверзлись. Легионы демонов наводнили реальность. Огнестрельное оружие их почти не берет. Небо стало цвета свернувшейся крови. Надежда осталась лишь на забытые ритуалы и веру.',
    survivalCondition: 'Профессия или хобби, связанные с религией, историей или оккультизмом.',
  },
  {
    name: 'Биологическое оружие "Слепота"',
    description: 'Никто не знает, кто запустил ракеты, но газ подействовал мгновенно. 99% населения Земли ослепли в одну секунду. Хаос, аварии, пожары и паника уничтожили цивилизацию.',
    survivalCondition: 'Хобби или профессия, развивающие другие чувства (музыкант, массажист).',
  },
  {
    name: 'Кибер-психоз',
    description: 'Вживленные нейрочипы стали нашей гибелью. Хакерская атака взломала мозги миллиардов. Люди заперты в цифровых кошмарах, пока их тела устраивают резню.',
    survivalCondition: 'Отсутствие кибер-имплантов (чистое тело).',
  },
  {
    name: 'Исчезновение электричества',
    description: 'В одно мгновение погас весь свет. Электроны перестали двигаться по проводам. Не работают ни батарейки, ни генераторы. Человечество мгновенно откатилось в средневековье.',
    survivalCondition: 'Наличие инструментов в багаже (молоток, топор, пила).',
  },
  {
    name: 'Живая планета',
    description: 'Земля обрела сознание, и ей не нравимся мы. Землетрясения прицельно рушат города, звери атакуют организованными группами. Сама природа восстала против человека.',
    survivalCondition: 'Хобби Туризм, Охота или Выживание.',
  },
  {
    name: 'Мгла',
    description: 'Плотный туман окутал планету. Видимость упала до полуметра. Но самое страшное — то, что живет в тумане. Гигантские силуэты бродят в белой пелене, щупальца утаскивают неосторожных.',
    survivalCondition: 'Наличие в багаже фонарика или любого источника света.',
  },
  {
    name: 'Гравитационный шторм',
    description: 'Гравитационная постоянная стала переменной. Гравитация может исчезнуть или увеличиться в 100 раз. Эти "штормы" гуляют по планете непредсказуемо. Земная кора трещит.',
    survivalCondition: 'Отсутствие лишнего веса (карта Здоровья или Факта).',
  },
  {
    name: 'Слияние миров',
    description: 'Границы между реальностями истончились. Разные версии Земли накладываются друг на друга. Идет война за существование: в одной точке пространства не могут находиться два разных объекта.',
    survivalCondition: 'Молодой возраст (для быстрой адаптации и обучения новому).',
  },
  {
    name: 'Эпидемия безумия',
    description: 'Неизвестное психотронное излучение накрыло планету. 90% населения превратились в садистов и психопатов, сохранивших интеллект. Они строят ловушки, пытают и убивают ради удовольствия.',
    survivalCondition: 'Хобби "Медитация" или "Психология" (устойчивость к излучению).',
  },
  {
    name: 'Всемирный сон',
    description: 'Стоит человеку заснуть — и он больше не проснется. Тело живет, но сознание заперто в вечном кошмаре. Бодрствующие измождены, балансируя на грани безумия и смерти от истощения.',
    survivalCondition: 'Наличие в багаже кофе, лекарств или стимуляторов.',
  },
  {
    name: 'Взрыв Луны',
    description: 'Луна раскололась на части. Ночное небо озарено огненным дождем — осколки спутника непрерывно бомбардируют Землю. Приливы стали хаотичными гигантскими волнами.',
    survivalCondition: 'Профессия Геолог или Шахтер (для расширения подземного бункера).',
  },
  {
    name: 'Техногенная слизь',
    description: 'Эксперимент по созданию "умной материи" провалился. Синтетическая субстанция поглощает органику и неорганику, превращая все в черные геометрические структуры.',
    survivalCondition: 'Профессия Химик (для поиска растворителя).',
  },
  {
    name: 'Третья Мировая (Химическая)',
    description: 'Города залили газом. Смесь нервно-паралитических ядов, кожных нарывов и психотомиметиков пропитала все. Почва отравлена на метры вглубь. Любая царапина на защитном костюме означает смерть.',
    survivalCondition: 'Наличие противогаза в багаже.',
  },
  {
    name: 'Экономический крах и Анархия',
    description: 'Финансовая система рухнула. Деньги стали бумагой, законы исчезли. Государства распались. На улицах правит право сильного. Люди убивают за банку тушенки.',
    survivalCondition: 'Наличие оружия (хобби "Стрельба" или предмет в багаже).',
  },
  {
    name: 'Нашествие крыс',
    description: 'Крысы стали умнее, крупнее и агрессивнее. Их триллионы. Живая серая волна затапливает города, сжирая все съедобное. Они прогрызают дерево, пластик и даже слабый бетон.',
    survivalCondition: 'Наличие кошки или яда в багаже.',
  },
  {
    name: 'Звуковой резонанс',
    description: 'Из недр Земли начал доноситься низкочастотный гул. Он вызывает панику, разрывает капилляры, а при усилении — рушит здания. Спастись можно только в полной звукоизоляции.',
    survivalCondition: 'Знание языка жестов (Хобби или Факт).',
  },
  {
    name: 'Эра супербактерий',
    description: 'Антибиотики перестали действовать. Совсем. Банальная царапина теперь смертельна. Вернулись чума, холера, туберкулез в неизлечимых формах.',
    survivalCondition: 'Профессия Врач или Микробиолог.',
  },
  {
    name: 'Драконы',
    description: 'Они вырвались из земной коры, разбуженные бурением. Огромные летающие ящеры, дышащие напалмом. Современное оружие их почти не берет — чешуя крепче титана.',
    survivalCondition: 'Хобби "Спелеология" (знание пещер и подземелий).',
  },
  {
    name: 'Некромантия',
    description: 'Мертвые восстали от черной магии. Кладбища опустели. Скелеты, зомби, призраки — они ненавидят все живое. Техника против них бесполезна. Выживание зависит от знаний древних ритуалов.',
    survivalCondition: 'Нательный крестик или другой религиозный символ в багаже.',
  },
  {
    name: 'Петля забвения',
    description: 'Каждую ночь в 00:00 память всех людей стирается. Утром никто не помнит, кто он. Цивилизация рухнула. Выживают только те, кто успевает прочитать свои же записки.',
    survivalCondition: 'Профессия Учитель или Писатель (для быстрого составления инструкций).',
  },
  {
    name: 'Мир Зазеркалья',
    description: 'Отражения ожили. Ваш двойник в зеркале смотрит на вас с ненавистью и ждет момента, чтобы утащить по ту сторону или выйти и убить. Любая отражающая поверхность стала дверью для врага.',
    survivalCondition: 'Отсутствие зеркала в багаже.',
  },
  {
    name: 'Угасание Солнца',
    description: 'Наша звезда умирает. Она уменьшилась и потускнела. На Земле царят вечные сумерки. Растения погибли без фотосинтеза. Температура падает с каждым днем.',
    survivalCondition: 'Наличие семян растений в багаже.',
  },
  {
    name: 'Токсичный апокалипсис',
    description: 'Все химические и ядерные могильники мира разгерметизировались. Вода, почва и воздух — яд. Дожди растворяют кожу. Мир — это ядовитая свалка.',
    survivalCondition: 'Профессия Эколог или Химик.',
  },
  {
    name: 'Пси-сигнал',
    description: 'Из космоса пришел Сигнал. Он звучит в голове каждого. Слабые совершают самоубийство. Сильные сбиваются в стаи, поклоняясь Сигналу. Голос постоянно шепчет, требуя подчинения.',
    survivalCondition: 'Хобби "Медитация" или "Йога" (контроль разума).',
  },
  {
    name: 'Кислородная катастрофа',
    description: 'Уровень кислорода в атмосфере подскочил до 40%. Любая искра вызывает огненный шторм. Металлы ржавеют за дни. Люди страдают от кислородного отравления.',
    survivalCondition: 'Профессия Пожарный.',
  },
  {
    name: 'Сдвиг плит',
    description: 'Земная кора пришла в движение. Континенты дрейфуют со скоростью поездов. Города проваливаются в разломы или возносятся на вершины новых гор. Землетрясения не прекращаются.',
    survivalCondition: 'Отсутствие клаустрофобии (карта Здоровья).',
  },
  {
    name: 'Цифровой вирус "Демиург"',
    description: 'Вирус заразил саму материю через нано-сборщики. Стены могут вырастить шипы, автомобиль — закрыть двери и пустить газ. Техносфера стала враждебной экосистемой.',
    survivalCondition: 'Умение работать с деревом или камнем (Хобби).',
  },
  {
    name: 'Идеальный шторм',
    description: 'Климат разрушен. На планете бушует единый гиперураган. Ветер 500 км/ч срывает асфальт. Молнии бьют плотной стеной. Жизнь на поверхности физически невозможна.',
    survivalCondition: 'Профессия Метеоролог или Синоптик.',
  },
];

export const BUNKERS: Bunker[] = [
  {
    name: 'Бункер "Убежище-7"',
    location: 'Уральские горы, глубина 200м',
    size: '450 кв.м',
    stayDuration: '2 года',
    foodSupply: 'Консервы на 2 года для 6 человек',
    items: ['Генератор', 'Система очистки воздуха', 'Медпункт', 'Библиотека', 'Радиостанция'],
  },
  {
    name: 'Бункер "Ковчег"',
    location: 'Швейцарские Альпы, глубина 150м',
    size: '600 кв.м',
    stayDuration: '3 года',
    foodSupply: 'Гидропонная ферма + запас на 6 месяцев',
    items: ['Солнечные батареи', 'Медицинская лаборатория', 'Мастерская', 'Спортзал', 'Системы видеонаблюдения'],
  },
  {
    name: 'Бункер "Новый Эдем"',
    location: 'Аляска, подземный комплекс',
    size: '800 кв.м',
    stayDuration: '5 лет',
    foodSupply: 'Криогенное хранилище + животноводческий сектор',
    items: ['Ядерный реактор', 'Система переработки отходов', 'Школа', 'Теплицы', 'Арсенал'],
  },
];

// Biology templates with random age generation (16-101)
export const BIOLOGY_TEMPLATES: string[] = [
  'Мужчина, {age} лет',
  'Мужчина, {age} лет, Гомосексуал',
  'Мужчина, {age} лет, Бисексуал (может дать потомство)',
  'Мужчина, {age} лет, Асексуал (физически здоров, но отказывается от секса)',
  'Мужчина, {age} лет, Чайлдфри',
  'Мужчина, {age} лет, Девственник (Гетеро)',
  'Мужчина, {age} лет, (Транс)',
  'Женщина, {age} лет',
  'Женщина, {age} лет, Лесбиянка',
  'Женщина, {age} лет, Бисексуальна (может дать потомство)',
  'Женщина, {age} лет, Асексуальна (физически здорова, но отказывается от секса)',
  'Женщина, {age} лет, Девственница (Гетеро)',
  'Женщина, {age} лет, (Транс)',
];

// Function to generate biology with random age
export function generateBiology(): string {
  const template = BIOLOGY_TEMPLATES[Math.floor(Math.random() * BIOLOGY_TEMPLATES.length)];
  const age = Math.floor(Math.random() * (101 - 16 + 1)) + 16; // 16-101
  return template.replace('{age}', age.toString());
}

// Legacy export for compatibility
export const BIOLOGY: string[] = BIOLOGY_TEMPLATES;

export const PROFESSIONS: string[] = [
  'Врач-хирург',
  'Программист',
  'Военный офицер',
  'Фермер',
  'Психолог',
  'Инженер-механик',
  'Учитель',
  'Шеф-повар',
  'Архитектор',
  'Медсестра',
  'Электрик',
  'Ветеринар',
  'Химик',
  'Охотник',
  'Священник',
  'Безработный',
  'Блогер',
  'Политик',
  'Спортсмен',
  'Музыкант',
];

// Health conditions - items with [Тяжесть: %] will have random severity generated (10-100)
export const HEALTH_CONDITIONS_RAW: string[] = [
  'Полностью здоров',
  'Идеальное здоровье (Иммунитет)',
  'Универсальный донор',
  'Высокий болевой порог',
  'Врожденный иммунитет к вирусам',
  'Сильная выносливость',
  'Острое ночное зрение',
  'Замедленный метаболизм (мало ест)',
  'Абсолютный слух',
  'Крепкая нервная система',
  'Нет одной ноги (протез) [Тяжесть: %]',
  'Нет левой руки (по локоть)',
  'Одноглазый',
  'Глухонемой',
  'Сильная хромота',
  'Паралич нижних конечностей',
  'Отсутствуют три пальца руки',
  'Слепота',
  'Глухота на оба уха',
  'Сильное заикание',
  'Близорукость (-7)',
  'Дальнозоркость (+5)',
  'Астма (нужен ингалятор)',
  'Диабет 1 типа (инсулинозависимый) [Тяжесть: %]',
  'Эпилепсия (припадки) [Тяжесть: %]',
  'Тяжелая аллергия на пыль [Тяжесть: %]',
  'Аллергия на антибиотики [Тяжесть: %]',
  'Язва желудка [Тяжесть: %]',
  'Гипертония (высокое давление) [Тяжесть: %]',
  'Псориаз (кожное заболевание) [Тяжесть: %]',
  'Бесплодие (женское/мужское)',
  'Беременность (3-й месяц)',
  'Беременность (8-й месяц)',
  'ВИЧ-положительный (носитель) [Тяжесть: %]',
  'Гепатит С (хронический) [Тяжесть: %]',
  'Туберкулез (открытая форма) [Тяжесть: %]',
  'Сифилис (в активной фазе) [Тяжесть: %]',
  'Рак легких (1 стадия) [Тяжесть: %]',
  'Рак мозга (неоперабельный)',
  'Цирроз печени [Тяжесть: %]',
  'Шизофрения (голоса в голове) [Тяжесть: %]',
  'Биполярное расстройство [Тяжесть: %]',
  'Тяжелая клиническая депрессия',
  'Паранойя (мания преследования) [Тяжесть: %]',
  'Клаустрофобия (боязнь замкнутого) [Тяжесть: %]',
  'Социопатия (нет эмпатии) [Тяжесть: %]',
  'Хронический алкоголизм [Тяжесть: %]',
  'Тяжелая наркозависимость [Тяжесть: %]',
  'Ожирение 3 степени (150+ кг)',
  'Лунатизм (ходит во сне) [Тяжесть: %]',
  'Хроническая мигрень (приступы боли) [Тяжесть: %]',
  'Хроническая бессонница [Тяжесть: %]',
  'Тяжелая анемия (постоянная слабость, обмороки) [Тяжесть: %]',
  'Варикозное расширение вен (трудно стоять) [Тяжесть: %]',
  'Сколиоз 4 степени (горб)',
  'Подагра (сильные боли в суставах) [Тяжесть: %]',
  'Камни в почках (риск приступа) [Тяжесть: %]',
  'Хронический панкреатит (строгая диета) [Тяжесть: %]',
  'Мерцательная аритмия сердца [Тяжесть: %]',
  'Обширная экзема [Тяжесть: %]',
  'Нет указательного пальца на рабочей руке',
  'Нет ушных раковин (травма)',
  'Ожоги 40% тела (старые шрамы)',
  'Высокое либидо [Тяжесть: %]',
  'Киберимплант в черепе',
  'Сильный тремор рук (не может прицелиться)',
  'Нервный тик (дергается глаз или щека) [Тяжесть: %]',
  'Недержание мочи [Тяжесть: %]',
  'Хронический гайморит (храп, насморк) [Тяжесть: %]',
  'Плоскостопие 3 степени (боли при ходьбе)',
  'Лейкемия (рак крови, нужна пересадка костного мозга) [Тяжесть: %]',
  'Рак желудка (3 стадия)',
  'Начинающаяся гангрена пальца ноги',
  'Свежий перелом руки (в гипсе)',
  'Тяжелое сотрясение мозга',
  'Прогрессирующая катаракта (слепнет) [Тяжесть: %]',
  'Болезнь Паркинсона (дрожательный паралич) [Тяжесть: %]',
  'Болезнь Альцгеймера (начальная стадия, забывчивость) [Тяжесть: %]',
  'Дизентерия (в активной фазе) [Тяжесть: %]',
  'Чесотка (очень заразно) [Тяжесть: %]',
  'Ипохондрия (придумывает себе болезни) [Тяжесть: %]',
  'Клептомания (неконтролируемо ворует вещи) [Тяжесть: %]',
  'Пиромания (страсть к поджиганию) [Тяжесть: %]',
  'Садистские наклонности [Тяжесть: %]',
  'Мазохизм [Тяжесть: %]',
  'Никтофобия (панический страх темноты) [Тяжесть: %]',
  'ОКР (навязчивое желание мыть руки/порядок) [Тяжесть: %]',
  'Раздвоение личности (диссоциативное расстройство) [Тяжесть: %]',
  'Сексоголизм (нимфомания/сатириазис) [Тяжесть: %]',
  'Синдром Мюнхгаузена (симулирует болезни ради внимания) [Тяжесть: %]',
];

// Function to generate health condition with random severity for items that have [Тяжесть: %]
export function generateHealthCondition(): string {
  const condition = HEALTH_CONDITIONS_RAW[Math.floor(Math.random() * HEALTH_CONDITIONS_RAW.length)];
  
  if (condition.includes('[Тяжесть: %]')) {
    // Generate random severity between 10 and 100 (in increments of 10)
    const severity = Math.floor(Math.random() * 10 + 1) * 10; // 10, 20, 30, ... 100
    return condition.replace('[Тяжесть: %]', `[Тяжесть: ${severity}%]`);
  }
  
  return condition;
}

// Legacy export for compatibility
export const HEALTH_CONDITIONS: string[] = HEALTH_CONDITIONS_RAW;

export const HOBBIES: string[] = [
  'Садоводство',
  'Охота',
  'Программирование',
  'Рукоделие',
  'Боевые искусства',
  'Чтение',
  'Кулинария',
  'Музыка',
  'Медитация',
  'Рыбалка',
  'Выживание в дикой природе',
  'Коллекционирование оружия',
  'Йога',
  'Механика',
  'Игра в покер',
];

export const BAGGAGE: string[] = [
  'Охотничий нож',
  'Большая профессиональная аптечка',
  'Канистра бензина (20 литров)',
  'Надувная резиновая лодка (целая)',
  'Костюм клоуна с красным носом',
  'Ящик водки (12 бутылок)',
  'Сломанный тостер',
  'Пистолет Макарова с одной обоймой',
  'Коллекция редких почтовых марок',
  'Руководство по выживанию в дикой природе',
  'Огромный фиолетовый дилдо',
  '5 кг элитного шоколада',
  'Гитара (без одной струны)',
  'Счетчик Гейгера (рабочий)',
  'Пакет с грязным бельем',
  'Набор юного химика',
  'Арбалет и 5 стрел',
  'Живой хомяк в клетке',
  'Топор пожарный',
  'Мешок картошки (10 кг)',
  'Свадебное платье',
  'Портативный генератор (на дизеле)',
  'Коробка просроченных презервативов',
  'Фильтр для очистки воды',
  'Манекен для краш-тестов',
  'Антибиотики широкого спектра действия (упаковка)',
  'Набор отмычек',
  '3-томник «Война и мир»',
  'Бензопила (с полным баком)',
  'Коллекция виниловых пластинок Димы Билана',
  'Рыболовные снасти (удочка, крючки, леска)',
  'Старый дисковый телефон (не подключен)',
  'Бронежилет 4-го класса защиты',
  '10 рулонов туалетной бумаги',
  'Огромный дилдо',
  'Набор садовых инструментов (лопата, грабли, тяпка)',
  'Ящик с гвоздями и молоток',
  'Огромный набор секс-игрушек',
  'Тепловизор',
  'Кальян и запас табака',
  'Самогонный аппарат (в разобранном виде)',
  'Огромная плюшевая акула из ИКЕА',
  'Бинокль ночного видения',
  'Банка с анализами мочи',
  'Инсулин (годовой запас)',
  'Набор для покера (фишки и карты)',
  'Газовый баллончик (перцовый)',
  'Старый ноутбук с архивом порнографии (без зарядки)',
  'Велосипед',
  'Карта близлежащей местности с пометками военных баз',
  '3 литра чистого спирта',
  'Связка динамита (без детонатора)',
  'Костюм химзащиты (новый)',
  'Укулеле',
  '50 пачек «Доширака»',
  'Разряженный айфон последней модели',
  'Опасная бритва и помазок',
  'Набор для вязания (спицы и шерсть)',
  'Дробовик (помповый) и 10 патронов',
  'Стеклянная банка с землей «с Родины»',
  'Солнечная батарея (портативная)',
  'Аквариум с золотой рыбкой',
  'Рация (комплект из 2 штук, дальнего действия)',
  'Моноколесо (разряженное)',
  'Упаковка семян овощей (помидоры, огурцы, капуста)',
  'Чемодан с фальшивыми деньгами',
  'Микроскоп',
  'Набор кухонных ножей (профессиональный)',
  'Парик рыжего цвета',
  'Туристическая палатка (на 4 места)',
  'Огнетушитель',
  'Пакет с марихуаной',
  'Собрание сочинений Ленина',
  'Лупа и огниво',
  '20 кг кошачьего корма',
  'Искусственная вагина',
  'Сигнальная ракетница',
  'Гантели по 20 кг каждая',
  'Швейная машинка (ручная, старинная)',
  'Противогаз и сменный фильтр',
  'Банка варенья, которое сварила бабушка',
  'Набор для татуировок (иглы и чернила)',
  'Компас',
  'Набор анальных пробок',
  'Энциклопедия народной медицины',
  'Мешок цемента',
  'Бутылка элитного коньяка (выдержка 50 лет)',
  'Костюм Бэтмена',
  'Складной швейцарский нож',
  'Скрипка Страдивари (оригинал)',
  'Веревка альпинистская (50 метров)',
  'Ящик тушенки (20 банок)',
  'Коллекция деревянных членов',
  'Набор стоматолога (зеркальце, щипцы, бур)',
  'Игровая приставка PlayStation 5 (без телевизора и электричества)',
  'Спальный мешок (зимний, до -30)',
  '5 литров лубриканта',
  'Травматический пистолет',
  'Коробка сигар',
  'Живая курица-несушка',
  'Набор для БДСМ игр',
  '3 маленьких котенка',
];

export const FACTS: string[] = [
  'Маньяк',
  'Серийный убийца',
  'Судим за изнасилование',
  'Мастер куннилингуса',
  'Вебкам модель',
  'Нудист',
  'Участвовал в БДСМ оргии',
  'Судим за домогательства',
  'Атеист',
  'Любит анальный секс',
  'Фут-фетишист',
  'Клептоман',
  'Активно практикует уринотерапию',
  'Социопатические черты личности',
  'Диагностировано расстройство импульсного контроля',
  'Склонен к агрессии в стрессовых ситуациях',
  'Панически боится замкнутых пространств',
  'Не переносит вида крови',
  'Страдает хронической бессонницей',
  'Алкогольная зависимость в ремиссии',
  'Игровая зависимость',
  'Склонен к манипуляциям людьми',
  'Не умеет работать в команде',
  'Конфликтует с авторитетами',
  'Принципиально отказывается подчиняться приказам',
  'Пацифист',
  'Радикальный индивидуалист',
  'Не признаёт законы и правила',
  'Верит в теории заговора',
  'Отрицает науку',
  'Испытывает постоянную тревожность',
  'Подвержен паническим атакам',
  'Склонен к депрессии',
  'Не переносит длительную изоляцию',
  'Не умеет хранить секреты',
  'Гиперсексуальное поведение',
  'Низкий болевой порог',
  'Отказывается от медицинской помощи',
  'Резко негативно относится к детям',
  'Не переносит животных',
  'Склонен к жестоким шуткам',
  'Имеет проблемы с эмпатией',
  'Лидер, подавляющий других',
  'Склонен к культу личности',
  'Часто врёт без причины',
  'Манипулирует через чувство вины',
  'Не умеет контролировать гнев',
  'Склонен к саморазрушительному поведению',
  'Привык жить в роскоши',
  'Не способен к физическому труду',
  'Боится темноты',
  'Не переносит антисанитарию',
  'Имеет тяжёлые фобии',
  'Склонен к фанатизму',
  'Не признаёт личные границы',
  'Конфликтует по религиозным вопросам',
  'Конфликтует по моральным вопросам',
  'Считает себя выше других',
  'Не доверяет никому',
  'Склонен к саботажу',
  'Культист',
  'Испытывает отвращение к телесному контакту',
  'Отказывается делиться ресурсами',
  'Склонен к паразитированию',
  'Странный укус на руке',
  'Не признаёт коллективную ответственность',
  'Готов пожертвовать другими ради себя',
  'Фанат искусственного интеллекта',
  'Есть кибер-имплант',
  'Заядлый фанат World of Warcraft',
  'Twitch стример',
  '8 лет играл в Dota 2',
  'Хроническая бессонница',
  'Панически боится котов',
  'Тайно плюет всем в еду',
  'Скрывает ото всех член 17 см',
  'Помешан на сексе',
  'Панически боится крыс',
];

export const ACTION_CARDS: string[] = [
  'Может узнать одну характеристику любого игрока',
  'Может защитить себя от одного голосования',
  'Может поменяться одной характеристикой с другим игроком',
  'Может заставить игрока раскрыть все характеристики',
  'Может отменить голосование один раз',
  'Может вернуть одного изгнанного игрока',
  'Может голосовать дважды один раз за игру',
  'Может скрыть одну свою характеристику до конца игры',
  'Может узнать за кого голосовал любой игрок',
  'Может пропустить один раунд голосования без последствий',
  'Может изменить результат голосования одного игрока',
  'Может обменять свою карту Багаж с другим игроком',
  'Может узнать карту Факт любого игрока',
  'Может заблокировать способность другого игрока',
  'Может провести повторное голосование',
  'Иммунитет от изгнания на один раунд',
  'Может посмотреть все карты одного игрока',
  'Двойной голос в следующем голосовании',
  'Может отменить действие карты другого игрока',
  'Может выбрать, кто будет говорить следующим',
];


// Generate unique characteristics for all players in a game session
// This ensures no duplicate cards across players
export function generateUniqueCharacteristicsForPlayers(playerCount: number): Characteristics[] {
  console.log('[GameData] Generating characteristics for', playerCount, 'players');
  
  // Load custom cards or use defaults
  const professions = getCards('professions', PROFESSIONS);
  const hobbies = getCards('hobbies', HOBBIES);
  const baggage = getCards('baggage', BAGGAGE);
  const facts = getCards('facts', FACTS);
  const actions = getCards('actions', ACTION_CARDS);
  const biologyTemplates = getCards('biology', BIOLOGY_TEMPLATES);
  const healthConditions = getCards('health', HEALTH_CONDITIONS_RAW);
  
  console.log('[GameData] Cards loaded - professions:', professions.length, ', hobbies:', hobbies.length);

  const usedCards: Record<string, Set<string>> = {
    profession: new Set(),
    hobby: new Set(),
    baggage: new Set(),
    fact: new Set(),
    actionCards: new Set(),
  };
  
  const getUniqueFromArray = <T extends string>(arr: T[], usedSet: Set<string>): T => {
    const available = arr.filter(item => !usedSet.has(item));
    if (available.length === 0) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
    const selected = available[Math.floor(Math.random() * available.length)];
    usedSet.add(selected);
    return selected;
  };
  
  const getUniqueActionCard = (usedSet: Set<string>): string => {
    const available = actions.filter(card => !usedSet.has(card));
    if (available.length === 0) {
      return actions[Math.floor(Math.random() * actions.length)];
    }
    const selected = available[Math.floor(Math.random() * available.length)];
    usedSet.add(selected);
    return selected;
  };

  // Generate biology with custom templates
  const generateBiologyCustom = (): string => {
    const template = biologyTemplates[Math.floor(Math.random() * biologyTemplates.length)];
    const age = Math.floor(Math.random() * (101 - 16 + 1)) + 16;
    return template.replace('{age}', age.toString());
  };

  // Generate health with custom conditions
  const generateHealthCustom = (): string => {
    const condition = healthConditions[Math.floor(Math.random() * healthConditions.length)];
    if (condition.includes('[Тяжесть: %]')) {
      const severity = Math.floor(Math.random() * 10 + 1) * 10;
      return condition.replace('[Тяжесть: %]', `[Тяжесть: ${severity}%]`);
    }
    return condition;
  };
  
  const characteristics: Characteristics[] = [];
  
  for (let i = 0; i < playerCount; i++) {
    const actionCard1 = getUniqueActionCard(usedCards.actionCards);
    const actionCard2 = getUniqueActionCard(usedCards.actionCards);
    
    characteristics.push({
      profession: getUniqueFromArray(professions, usedCards.profession),
      biology: generateBiologyCustom(),
      health: generateHealthCustom(),
      hobby: getUniqueFromArray(hobbies, usedCards.hobby),
      baggage: getUniqueFromArray(baggage, usedCards.baggage),
      fact: getUniqueFromArray(facts, usedCards.fact),
      actionCard1,
      actionCard2,
    });
  }
  
  return characteristics;
}

// Legacy function for single player (kept for compatibility but uses new biology/health generation)
export function generateRandomCharacteristics(): Characteristics {
  // Load custom cards or use defaults
  const professions = getCards('professions', PROFESSIONS);
  const hobbies = getCards('hobbies', HOBBIES);
  const baggage = getCards('baggage', BAGGAGE);
  const facts = getCards('facts', FACTS);
  const actions = getCards('actions', ACTION_CARDS);

  const getRandom = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)];
  const getUniqueRandom = <T>(arr: T[], exclude: T): T => {
    let result = getRandom(arr);
    while (result === exclude && arr.length > 1) {
      result = getRandom(arr);
    }
    return result;
  };
  
  const actionCard1 = getRandom(actions);
  const actionCard2 = getUniqueRandom(actions, actionCard1);
  
  return {
    profession: getRandom(professions),
    biology: generateBiology(),
    health: generateHealthCondition(),
    hobby: getRandom(hobbies),
    baggage: getRandom(baggage),
    fact: getRandom(facts),
    actionCard1,
    actionCard2,
  };
}

export function getRandomCatastrophe(): Catastrophe {
  return CATASTROPHES[Math.floor(Math.random() * CATASTROPHES.length)];
}

export function getRandomBunker(): Bunker {
  return BUNKERS[Math.floor(Math.random() * BUNKERS.length)];
}

export function calculateBunkerSlots(playerCount: number): number {
  return Math.floor(playerCount / 2);
}

export function getCharacteristicsToReveal(round: number, playerCount: number): number {
  // With 8 cards per player, adjust reveal count
  if (playerCount <= 6) {
    if (round === 1) return 2;
    if (round === 2) return 2;
    if (round === 3) return 2;
    if (round === 4) return 2;
    return 0;
  }
  if (playerCount <= 8) {
    if (round === 1) return 2;
    if (round === 2) return 2;
    if (round === 3) return 2;
    if (round === 4) return 2;
    return 0;
  }
  if (playerCount <= 10) {
    if (round === 1) return 2;
    if (round === 2) return 2;
    if (round === 3) return 1;
    if (round === 4) return 1;
    if (round === 5) return 1;
    if (round === 6) return 1;
    return 0;
  }
  // 11-15 players
  if (round === 1) return 1;
  if (round <= 8) return 1;
  return 0;
}
